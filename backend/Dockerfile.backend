# backend/Dockerfile.backend
FROM python:3.10-slim

# Install system deps for FAISS
RUN apt-get update && apt-get install -y build-essential git \
    && rm -rf /var/lib/apt/lists/*
    
WORKDIR /app

COPY backend/ ./backend/

# Add backend/ to PYTHONPATH
ENV PYTHONPATH="${PYTHONPATH}:/app/backend"

# Copy Python requirements & install
RUN pip install --no-cache-dir -r /app/backend/requirements.txt

# Ensure data folders exist
RUN mkdir -p /app/backend/data/hub/models--deepseek-ai--deepseek-r1-distill-qwen-1.5b

# Run the model download script during build
RUN python /app/backend/src/get_model.py

ENV DEEPSEEK_MODEL_PATH=/app/backend/data/hub/models--deepseek-ai--deepseek-r1-distill-qwen-1.5b

# Expose FastAPI port
EXPOSE 8000
    
# Run with reload in dev; remove --reload for prod
CMD ["uvicorn", "backend.app:app", "--host", "0.0.0.0", "--port", "8000"]
    