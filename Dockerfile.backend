# --- Backend Dockerfile ---
FROM python:3.9-slim

# Install system deps for FAISS
RUN apt-get update && apt-get install -y build-essential git \
    && rm -rf /var/lib/apt/lists/*
    
WORKDIR /app
    
# Copy Python requirements & install
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
    
# Copy code
COPY . .

# Copy frontend build
COPY frontend/build /app/build

# Ensure data folders exist
RUN mkdir -p /app/data/hub/models--deepseek-ai--deepseek-r1-distill-qwen-1.5b

# Run the model download script during build
RUN python /app/src/get_model.py

ENV DEEPSEEK_MODEL_PATH=/app/data/hub/models--deepseek-ai--deepseek-r1-distill-qwen-1.5b

# Expose FastAPI port
EXPOSE 8000
    
# Run with reload in dev; remove --reload for prod
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
    